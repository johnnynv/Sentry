# Sentry 实施计划

## 1. 项目结构

```
sentry/
├── main.go                    # 主程序入口
├── config.go                  # 配置加载和验证
├── monitor.go                 # 仓库监控服务
├── deploy.go                  # 部署执行服务
├── sentry.yaml                # 配置文件示例
├── .env.example               # 环境变量示例
├── go.mod                     # Go模块依赖
├── go.sum                     # 依赖版本锁定
├── Dockerfile                 # Docker镜像构建
├── Makefile                   # 构建脚本
├── README.md                  # 项目说明
└── docs/
    └── zh/
        ├── architecture.md    # 架构设计文档
        └── implementation.md  # 实施计划文档
```

## 2. 开发阶段规划

### 阶段1：项目初始化 (Day 1)

#### 1.1 创建项目结构
- [ ] 初始化 Git 仓库
- [ ] 创建 Go 模块 (`go mod init sentry`)
- [ ] 创建基本目录结构
- [ ] 添加 `.gitignore` 文件

#### 1.2 依赖管理
- [ ] 添加 Go 依赖到 `go.mod`
- [ ] 获取 YAML 解析库：`go get gopkg.in/yaml.v3`
- [ ] 获取环境变量支持：`go get github.com/joho/godotenv`
- [ ] 验证依赖完整性：`go mod tidy`

#### 1.3 配置管理模块 (`config.go`)
- [ ] 定义配置结构体
- [ ] 实现 YAML 配置文件解析
- [ ] 实现环境变量替换功能
- [ ] 添加配置验证逻辑
- [ ] 编写配置模块单元测试
- [ ] 创建配置文件示例

#### 1.4 基础文件
- [ ] 创建 `sentry.yaml` 配置示例
- [ ] 创建 `.env.example` 环境变量示例
- [ ] 编写基本的 `README.md`

**阶段1验证检查点**：
- [ ] 配置文件能正确解析
- [ ] 环境变量替换功能正常
- [ ] 配置验证逻辑有效
- [ ] 单元测试通过

### 阶段2：核心功能开发 (Day 2-3)

#### 2.1 监控服务 (`monitor.go`)
- [ ] 实现 GitHub API 调用逻辑
- [ ] 实现 GitLab API 调用逻辑
- [ ] 添加最新提交获取功能
- [ ] 实现变更检测逻辑
- [ ] 添加定时轮询机制
- [ ] 编写监控服务单元测试
- [ ] 添加网络错误重试机制

**阶段2.1验证检查点**：
- [ ] API 调用功能正常
- [ ] 变更检测逻辑正确
- [ ] 单元测试覆盖主要功能

#### 2.2 部署服务 (`deploy.go`)
- [ ] 实现 Git 仓库克隆功能
- [ ] 添加 .tekton 目录扫描
- [ ] 实现 YAML 文件过滤
- [ ] 添加 kubectl 命令执行
- [ ] 实现临时文件清理
- [ ] 编写部署服务单元测试
- [ ] 添加错误处理和回滚机制

**阶段2.2验证检查点**：
- [ ] Git 操作功能正常
- [ ] kubectl 执行成功
- [ ] 文件清理机制有效

#### 2.3 主程序框架 (`main.go`)
- [ ] 实现命令行参数解析
- [ ] 添加三个主要操作：`watch`、`trigger`、`validate`
- [ ] 实现信号处理（优雅退出）
- [ ] 添加基本日志输出
- [ ] 集成监控和部署服务
- [ ] 编写主程序集成测试

**阶段2.3验证检查点**：
- [ ] 三个主要操作功能正常
- [ ] 模块间集成无问题
- [ ] 信号处理工作正常

### 阶段3：集成测试和完善 (Day 4-5)

#### 3.1 端到端集成测试
- [ ] 准备测试用的 GitHub/GitLab 仓库
- [ ] 测试完整的监控-部署流程
- [ ] 验证手动触发功能
- [ ] 测试配置验证功能
- [ ] 验证在真实环境中的表现

#### 3.2 性能和稳定性优化
- [ ] 完善日志输出格式
- [ ] 添加详细错误信息
- [ ] 实现优雅的错误恢复
- [ ] 优化内存使用和性能
- [ ] 长时间运行稳定性测试

#### 3.3 代码质量完善
- [ ] 代码审查和重构
- [ ] 添加必要的注释和文档
- [ ] 确保代码风格一致性
- [ ] 最终的单元测试补充

### 阶段4：构建和部署 (Day 6-7)

#### 4.1 构建配置
- [ ] 编写 `Makefile` 构建脚本
- [ ] 创建 `Dockerfile` 多阶段构建
- [ ] 添加版本信息嵌入
- [ ] 配置交叉编译

#### 4.2 Kubernetes 部署
- [ ] 创建 Kubernetes Secret 配置
- [ ] 编写 Deployment 配置文件
- [ ] 添加 RBAC 权限配置
- [ ] 创建 ConfigMap 资源

#### 4.3 文档完善
- [ ] 完善 README.md 使用说明
- [ ] 添加配置参数说明
- [ ] 编写部署指南
- [ ] 创建故障排查文档

## 3. 开发环境准备

### 3.1 本地开发环境
1. **安装 Go 1.21+**
2. **准备测试仓库**：
   - GitHub 测试仓库 (repo A)
   - GitLab 测试仓库 (repo B，包含 .tekton 目录)
3. **获取访问令牌**：
   - GitHub Personal Access Token
   - GitLab Access Token
4. **配置 kubectl**：
   - 连接到测试 Kubernetes 集群
   - 确保有 tekton-pipelines 命名空间权限

### 3.2 Go 依赖
依赖管理已集成到阶段1中，确保在开发开始前完成：
```bash
go get gopkg.in/yaml.v3           # YAML配置解析
go get github.com/joho/godotenv   # .env文件支持
go mod tidy                       # 整理依赖
```

### 3.3 外部工具
- Git (仓库操作)
- kubectl (Kubernetes部署)
- Docker (镜像构建)

## 4. 开发流程

### 4.1 优化后的每日开发流程

**Day 1: 基础设施**
- 项目初始化 → 依赖管理 → 配置管理 + 测试

**Day 2-3: 核心开发（采用模块化开发-测试循环）**
- Day 2: 监控服务开发 + 单元测试 + 验证
- Day 3: 部署服务开发 + 单元测试 → 主程序集成 + 集成测试

**Day 4-5: 集成完善**
- 端到端测试 → 性能优化 → 稳定性验证

**Day 6-7: 构建部署**
- 构建配置 → 容器化 → Kubernetes部署 → 文档完善

### 4.2 测试验证步骤
```bash
# 1. 配置验证
./sentry -action=validate

# 2. 手动触发测试
./sentry -action=trigger

# 3. 监控功能测试 (短时间)
./sentry -action=watch
```

### 4.3 代码提交规范
- `feat: 添加监控服务功能`
- `fix: 修复配置加载问题`
- `docs: 更新使用说明`
- `test: 添加单元测试`

## 5. 部署验证

### 5.1 本地部署测试
1. **构建二进制文件**：`make build`
2. **功能验证**：运行所有测试用例
3. **性能测试**：长时间运行验证稳定性

### 5.2 Docker 部署测试
1. **构建镜像**：`make docker`
2. **容器测试**：验证环境变量注入
3. **网络连通性**：测试 API 访问和 kubectl 执行

### 5.3 Kubernetes 部署测试
1. **创建 Secret**：部署认证信息
2. **部署应用**：`kubectl apply -f k8s-deploy.yaml`
3. **功能验证**：查看日志，确认监控和部署正常

## 6. 交付清单

### 6.1 代码交付
- [ ] 源代码 (4个核心文件)
- [ ] 配置文件示例
- [ ] 构建脚本和 Dockerfile
- [ ] Kubernetes 部署文件

### 6.2 文档交付
- [ ] 架构设计文档
- [ ] 用户使用手册
- [ ] 部署运维指南
- [ ] 故障排查手册

### 6.3 测试交付
- [ ] 单元测试用例
- [ ] 集成测试脚本
- [ ] 性能测试报告
- [ ] 安全性检查报告

## 7. 风险控制

### 7.1 技术风险
- **API 限制**：实现退避重试机制
- **网络问题**：添加超时和错误处理
- **权限问题**：提供详细的权限配置说明

### 7.2 进度风险
- **功能复杂度**：严格按照最小可行产品开发
- **测试时间**：并行进行开发和测试
- **集成问题**：每日集成验证，及早发现问题

### 7.3 质量控制
- **代码审查**：确保代码简洁可维护
- **功能测试**：每个功能都要有对应测试
- **文档同步**：代码变更及时更新文档

## 8. 成功标准

- ✅ 能够监控指定 Git 仓库的分支变化
- ✅ 检测到变化后自动部署 Tekton 配置
- ✅ 支持手动触发部署功能
- ✅ 支持 GitHub 和 GitLab 两个平台
- ✅ 提供完整的配置验证和错误处理
- ✅ 可以通过 Kubernetes 稳定运行
- ✅ 代码量控制在 600 行以内
- ✅ 外部依赖少于 3 个

**预计完成时间：7 个工作日**
